import{b as o,d as P,g as $,o as w,c as x,f as S,w as b,k as F,l as Q,v as J,a as k,e as E,i as L,p as K,j as Y,E as T}from"./index-C5k89M8f.js";import{a as G}from"./axios-BimPEqV4.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";function H(n){return G({url:"http://10.100.161.12:9880/tts",method:"get",responseType:"blob",params:n})}async function W(n){const l="854c4025af0e7c0d6c7e32889b8e0341.34gzcFnIvhFYDEsY",r="https://open.bigmodel.cn/api/paas/v4/chat/completions",u={model:"glm-4",messages:n,stream:!0};return await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify(u)})}const X=n=>(K("data-v-49c3cff2"),n=n(),Y(),n),Z={class:"container"},ee={key:0,class:"response"},te=X(()=>k("h2",null,"AI 回复:",-1)),ae={key:1},oe={__name:"index",setup(n){const l=o(""),r=o(""),u=o([]),v=o(!1),h=o(!1),y=o(null),i=o(""),m=o([]),p=o(!1),d=o([]),f=o(0),U=async()=>{const e=JSON.stringify(d.value,null,2),t=new Blob([e],{type:"application/json"}),a=document.createElement("a");a.download=`messages_${g()}.json`,a.href=URL.createObjectURL(t),a.click(),URL.revokeObjectURL(a.href)},R=async()=>{if(!l.value.trim()){T.error("请输入内容！");return}const e=l.value;d.value.push({role:"system",content:"你是一个可爱的秘书，请根据用户输入提供简洁明了的回复。对话时间："+g()}),d.value.push({role:"user",content:e}),await C(),l.value=""},g=()=>{const e=new Date;return`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日${e.getHours()}时${e.getMinutes()}分${e.getSeconds()}秒:`};P(()=>{console.log(g())});const C=async e=>{M();try{const t=await W(d.value);t.ok&&t.body&&await N(t.body)}catch(t){z(t,"请求出错")}},N=async e=>{const t=e.getReader(),a=new TextDecoder;let s=!1;for(;!s;){const{value:c,done:I}=await t.read();s=I;const _=a.decode(c,{stream:!0});V(_)}d.value.push({role:"assistant",content:r.value}),p.value||B()},V=e=>{e.split(`
`).filter(a=>a.startsWith("data:")).forEach(a=>{var c;const s=a.replace("data: ","").trim();if(s!=="[DONE]"){const _=(c=JSON.parse(s).choices[0].delta)==null?void 0:c.content;_&&(i.value+=_,A())}})},A=()=>{const e=/[。？!！.]/;let t;for(;(t=e.exec(i.value))!==null;){const a=i.value.slice(0,t.index+1).trim();i.value=i.value.slice(t.index+1),r.value+=a+`
`,m.value.push(a)}},B=async()=>{if(!p.value){for(p.value=!0;m.value.length>0;){const e=m.value.shift();await D(e)}p.value=!1}},D=async e=>{try{await O(e.trim())}catch(t){console.error("TTS 请求失败:",t),T.error("TTS 请求失败，请稍后再试。")}},O=async e=>{const a=await H({text:e,text_lang:"zh",ref_audio_path:"E:\\losheep\\project\\AI\\GPT-SoVITS-v2-240821\\models\\jinxi\\jinxi.wav",prompt_lang:"zh",prompt_text:"这几间密室相对隐蔽，大家都能暂时喘口气……",text_split_method:"cut5",batch_size:1,media_type:"wav",streaming_mode:!0}),s=URL.createObjectURL(new Blob([a.data],{type:"audio/wav"}));u.value.push(s),u.value.length===1&&j()},j=()=>{if(f.value<u.value.length){const e=u.value[f.value];y.value.src=e,y.value.play(),f.value++,h.value||(h.value=!0,v.value=!1)}},M=()=>{v.value=!0,r.value="",h.value=!1,u.value=[],f.value=0,i.value="",m.value=[],p.value=!1,console.log(d.value)},z=(e,t)=>{console.error(`${t}:`,e),T.error(`${t}: ${e.message}`)};return(e,t)=>{const a=$("el-button"),s=$("el-input");return w(),x("div",Z,[S(s,{class:"text",placeholder:"请输入内容",modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=c=>l.value=c),onKeyup:F(R,["enter"])},{append:b(()=>[S(a,{onClick:R},{default:b(()=>[L("发送")]),_:1})]),_:1},8,["modelValue"]),h.value?(w(),x("div",ee,[te,Q(k("textarea",{"onUpdate:modelValue":t[1]||(t[1]=c=>r.value=c),rows:"5",readonly:""},null,512),[[J,r.value]])])):E("",!0),v.value?(w(),x("div",ae,"加载中...")):E("",!0),k("audio",{ref_key:"audioPlayer",ref:y,onEnded:j,style:{display:"none"}},null,544),S(a,{onClick:U,type:"primary"},{default:b(()=>[L("下载消息")]),_:1})])}}},ce=q(oe,[["__scopeId","data-v-49c3cff2"]]);export{ce as default};
