import{e as a,i as P,a9 as j,o as x,c as w,Q as S,S as b,ac as Q,a0 as F,ad as Y,a as k,Y as E,W as L,ay as J,az as K}from"./@vue-CR-AUDWE.js";import{a as G}from"./axios-BimPEqV4.js";import{_ as W}from"./plugin-vueexport-helper-DlAUqK2U.js";import{E as T}from"./element-plus-ClZLTU_R.js";import"./lodash-es-C3iSY8xh.js";import"./@vueuse-Ow68VHT1.js";import"./@element-plus-WrbGKrFN.js";import"./@popperjs-D9SI2xQl.js";import"./@ctrl-r5W6hzzQ.js";import"./dayjs-Ct2Knyoi.js";import"./async-validator-DKvM95Vc.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui-BzoSObgK.js";function q(n){return G({url:"http://10.100.161.12:9880/tts",method:"get",responseType:"blob",params:n})}async function H(n){const l="854c4025af0e7c0d6c7e32889b8e0341.34gzcFnIvhFYDEsY",c="https://open.bigmodel.cn/api/paas/v4/chat/completions",u={model:"glm-4",messages:n,stream:!0};return await fetch(c,{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify(u)})}const X=n=>(J("data-v-49c3cff2"),n=n(),K(),n),Z={class:"container"},ee={key:0,class:"response"},te=X(()=>k("h2",null,"AI 回复:",-1)),oe={key:1},ae={__name:"index",setup(n){const l=a(""),c=a(""),u=a([]),v=a(!1),m=a(!1),y=a(null),i=a(""),h=a([]),d=a(!1),p=a([]),f=a(0),U=async()=>{const e=JSON.stringify(p.value,null,2),t=new Blob([e],{type:"application/json"}),o=document.createElement("a");o.download=`messages_${g()}.json`,o.href=URL.createObjectURL(t),o.click(),URL.revokeObjectURL(o.href)},R=async()=>{if(!l.value.trim()){T.error("请输入内容！");return}const e=l.value;p.value.push({role:"system",content:"你是一个可爱的秘书，请根据用户输入提供简洁明了的回复。对话时间："+g()}),p.value.push({role:"user",content:e}),await C(),l.value=""},g=()=>{const e=new Date;return`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日${e.getHours()}时${e.getMinutes()}分${e.getSeconds()}秒:`};P(()=>{console.log(g())});const C=async e=>{M();try{const t=await H(p.value);t.ok&&t.body&&await N(t.body)}catch(t){z(t,"请求出错")}},N=async e=>{const t=e.getReader(),o=new TextDecoder;let s=!1;for(;!s;){const{value:r,done:$}=await t.read();s=$;const _=o.decode(r,{stream:!0});V(_)}p.value.push({role:"assistant",content:c.value}),d.value||B()},V=e=>{e.split(`
`).filter(o=>o.startsWith("data:")).forEach(o=>{var r;const s=o.replace("data: ","").trim();if(s!=="[DONE]"){const _=(r=JSON.parse(s).choices[0].delta)==null?void 0:r.content;_&&(i.value+=_,A())}})},A=()=>{const e=/[。？!！.]/;let t;for(;(t=e.exec(i.value))!==null;){const o=i.value.slice(0,t.index+1).trim();i.value=i.value.slice(t.index+1),c.value+=o+`
`,h.value.push(o)}},B=async()=>{if(!d.value){for(d.value=!0;h.value.length>0;){const e=h.value.shift();await D(e)}d.value=!1}},D=async e=>{try{await O(e.trim())}catch(t){console.error("TTS 请求失败:",t),T.error("TTS 请求失败，请稍后再试。")}},O=async e=>{const o=await q({text:e,text_lang:"zh",ref_audio_path:"E:\\losheep\\project\\AI\\GPT-SoVITS-v2-240821\\models\\jinxi\\jinxi.wav",prompt_lang:"zh",prompt_text:"这几间密室相对隐蔽，大家都能暂时喘口气……",text_split_method:"cut5",batch_size:1,media_type:"wav",streaming_mode:!0}),s=URL.createObjectURL(new Blob([o.data],{type:"audio/wav"}));u.value.push(s),u.value.length===1&&I()},I=()=>{if(f.value<u.value.length){const e=u.value[f.value];y.value.src=e,y.value.play(),f.value++,m.value||(m.value=!0,v.value=!1)}},M=()=>{v.value=!0,c.value="",m.value=!1,u.value=[],f.value=0,i.value="",h.value=[],d.value=!1,console.log(p.value)},z=(e,t)=>{console.error(`${t}:`,e),T.error(`${t}: ${e.message}`)};return(e,t)=>{const o=j("el-button"),s=j("el-input");return x(),w("div",Z,[S(s,{class:"text",placeholder:"请输入内容",modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=r=>l.value=r),onKeyup:Q(R,["enter"])},{append:b(()=>[S(o,{onClick:R},{default:b(()=>[L("发送")]),_:1})]),_:1},8,["modelValue"]),m.value?(x(),w("div",ee,[te,F(k("textarea",{"onUpdate:modelValue":t[1]||(t[1]=r=>c.value=r),rows:"5",readonly:""},null,512),[[Y,c.value]])])):E("",!0),v.value?(x(),w("div",oe,"加载中...")):E("",!0),k("audio",{ref_key:"audioPlayer",ref:y,onEnded:I,style:{display:"none"}},null,544),S(o,{onClick:U,type:"primary"},{default:b(()=>[L("下载消息")]),_:1})])}}},ye=W(ae,[["__scopeId","data-v-49c3cff2"]]);export{ye as default};
